<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>éŠæˆ²å›æ”¾</title>
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { background-color: #000; display: flex; flex-direction: column; align-items: center; color: white; font-family: "å¾®è»Ÿæ­£é»‘é«”", sans-serif; margin: 0; }
    canvas { background-color: #111; border: 3px solid #fff; margin-top: 10px; }
    #replay-status { margin: 10px; }
    #controls { margin-top: 10px; display: flex; gap: 10px; align-items: center; }
    .btn { background: #444; color: white; padding: 10px 20px; border-radius: 10px; font-size: 16px; user-select: none; cursor: pointer; }
    .btn:active { background: #777; }
    #progress-slider { width: 400px; margin-top: 15px; cursor: pointer; }
    #back-link { color: #6cf; margin-top: 20px; font-size: 18px; text-decoration: none; }
    #back-link:hover { text-decoration: underline; }
  </style>
</head>
<body>
  <h1>ğŸ éŠæˆ²å›æ”¾</h1>
  <p style="color: #ffcc00; font-size: 14px; margin: -5px 0 10px 0;">è«‹å‹™å¿…è¨˜ä½æ­¤ç¶²å€é€£çµ é–‹å§‹ä¸‹ä¸€å ´éŠæˆ²å¾Œä½ å°±å›ä¸ä¾†äº†!</p>
  <p id="replay-status">è¼‰å…¥ä¸­...</p>
  <canvas id="game" width="400" height="400"></canvas>
  <input type="range" id="progress-slider" value="0" step="1">
  <div id="controls">
    <div class="btn" id="restart-btn">â®ï¸ é‡é ­</div>
    <div class="btn" id="play-pause-btn">â–¶ï¸ æ’­æ”¾</div>
    <div id="frame-counter">0 / 0</div>
  </div>
  <a id="back-link" href="index.html">è¿”å›éŠæˆ²</a>

  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAtkZyxuP2alDTUm1AA7EAlPYSvvZAznEI",
      authDomain: "cogent-altar-468009-p7.firebaseapp.com",
      projectId: "cogent-altar-468009-p7",
      storageBucket: "cogent-altar-468009-p7.firebasestorage.app",
      messagingSenderId: "849610525376",
      appId: "1:849610525376:web:154b5103d027710734fb25"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const canvas = document.getElementById("game");
    const ctx = canvas.getContext("2d");
    const statusText = document.getElementById("replay-status");
    const playPauseBtn = document.getElementById("play-pause-btn");
    const restartBtn = document.getElementById("restart-btn");
    const progressSlider = document.getElementById("progress-slider");
    const frameCounter = document.getElementById("frame-counter");

    const gridSize = 20;
    const tileCount = canvas.width / gridSize;

    let replayData = [];
    let currentFrameIndex = 0;
    let isPlaying = false;
    let playbackInterval;

    function drawFrame(index) {
      const frame = replayData[index];
      if (!frame) return;
      currentFrameIndex = index;

      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.fillStyle = "red";
      ctx.fillRect(frame.apple.x * gridSize, frame.apple.y * gridSize, gridSize, gridSize);
      ctx.fillStyle = "lime";
      for (let s of frame.snake) {
        ctx.fillRect(s.x * gridSize, s.y * gridSize, gridSize - 1, gridSize - 1);
      }
      ctx.fillStyle = "white";
      ctx.font = "16px sans-serif";
      ctx.fillText("åˆ†æ•¸ï¼š" + frame.score, 10, 390);

      progressSlider.value = index;
      frameCounter.textContent = `${index + 1} / ${replayData.length}`;
    }

    function togglePlayPause() { isPlaying ? pause() : play(); }
    function play() {
      if (currentFrameIndex >= replayData.length - 1) return;
      isPlaying = true;
      playPauseBtn.textContent = "â¸ï¸ æš«åœ";
      playbackInterval = setInterval(() => {
        if (currentFrameIndex < replayData.length - 1) {
          drawFrame(currentFrameIndex + 1);
        } else {
          pause();
        }
      }, 150);
    }
    function pause() {
      isPlaying = false;
      playPauseBtn.textContent = "â–¶ï¸ æ’­æ”¾";
      clearInterval(playbackInterval);
    }
    function restart() {
      pause();
      drawFrame(0);
    }

    // --- ã€æœ€çµ‚ä¿®æ”¹ã€‘ä»¥çµ•å°ç²¾æº–çš„æ™‚åºé‡å¯«å›æ”¾å¼•æ“ ---
    function generateFramesFromHistory(initialState, moves) {
        let snake = JSON.parse(JSON.stringify(initialState.snake));
        let apple = { ...initialState.apple };
        let score = 0;
        let dx = 0, dy = 0; // éŠæˆ²é–‹å§‹æ™‚æ˜¯éœæ­¢çš„
        let frameCount = 0;
        let moveIndex = 0;
        const generatedFrames = [];

        // éŠæˆ²é–‹å§‹æ™‚ï¼Œå¦‚æœæ²’æœ‰ç«‹å³çš„æ“ä½œï¼Œé è¨­ä¸€å€‹åˆå§‹æ–¹å‘ (å‘å³)
        // é€™ç¢ºä¿äº†å³ä½¿ç¬¬ä¸€å€‹æŒ‡ä»¤åœ¨å¥½å¹¾å¹€ä¹‹å¾Œï¼Œè›‡ä¹Ÿæœƒå¾ä¸€é–‹å§‹å°±ç§»å‹•
        if (moves.length === 0 || moves[0].frame > 0) {
            dx = 1; dy = 0;
        }

        const MAX_FRAMES = 15000; // å®‰å…¨æ©Ÿåˆ¶ï¼Œé˜²æ­¢æ„å¤–çš„ç„¡é™è¿´åœˆ

        while (frameCount < MAX_FRAMES) {
            // 1. å„²å­˜ç•¶å‰å¹€ (N) çš„ç‹€æ…‹ï¼Œç”¨æ–¼ç¹ªè£½ã€‚
            // é€™å€‹ç‹€æ…‹æ˜¯åŸºæ–¼ N-1 å¹€çš„æŒ‡ä»¤è¨ˆç®—è€Œä¾†çš„ã€‚
            generatedFrames.push({
                snake: JSON.parse(JSON.stringify(snake)),
                apple: { ...apple },
                score: score
            });

            // 2. æª¢æŸ¥åœ¨ç•¶å‰å¹€ (N)ï¼Œç©å®¶æ˜¯å¦æŒ‰ä¸‹äº†æŒ‰éµã€‚
            // é€™å€‹æŒ‡ä»¤å°‡æ±ºå®š N+1 å¹€çš„ç§»å‹•æ–¹å‘ã€‚
            if (moveIndex < moves.length && moves[moveIndex].frame === frameCount) {
                const move = moves[moveIndex].move;
                if (move === 'u' && dy === 0) { dx = 0; dy = -1; }
                else if (move === 'd' && dy === 0) { dx = 0; dy = 1; }
                else if (move === 'l' && dx === 0) { dx = -1; dy = 0; }
                else if (move === 'r' && dx === 0) { dx = 1; dy = 0; }
                moveIndex++;
            }

            // å¦‚æœé‚„æ²’æ”¶åˆ°ç¬¬ä¸€å€‹æŒ‡ä»¤ï¼Œè›‡ä¿æŒä¸å‹•
            if (dx === 0 && dy === 0) {
                frameCount++;
                continue;
            }

            // 3. è¨ˆç®—è›‡é ­åœ¨ä¸‹ä¸€å¹€çš„ä½ç½® (ä½¿ç”¨ç•¶å‰çš„ dx, dy)
            const head = { x: snake[0].x + dx, y: snake[0].y + dy };

            // 4. æª¢æŸ¥æ˜¯å¦éŠæˆ²çµæŸ (æ’ç‰†æˆ–æ’è‡ªå·±)
            if (head.x < 0 || head.x >= tileCount || head.y < 0 || head.y >= tileCount || snake.some(s => s.x === head.x && s.y === head.y)) {
                break; // éŠæˆ²çµæŸï¼Œåœæ­¢æ¨¡æ“¬
            }

            // 5. æ›´æ–°è›‡çš„ç‹€æ…‹
            snake.unshift(head);

            if (head.x === apple.x && head.y === apple.y) {
                score++;
                // æª¢æŸ¥å‹åˆ©æ¢ä»¶
                if (snake.length >= tileCount * tileCount) {
                    break; // å‹åˆ©ï¼Œåœæ­¢æ¨¡æ“¬
                }
                // ã€ä¿®å¾©ã€‘ä½¿ç”¨èˆ‡ index.html åŒæ­¥çš„ã€å¯é çš„æ–¹æ³•ç”Ÿæˆæ–°è˜‹æœ
                const emptyCells = [];
                const snakeCellSet = new Set(snake.map(s => `${s.x},${s.y}`));

                for (let x = 0; x < tileCount; x++) {
                    for (let y = 0; y < tileCount; y++) {
                        if (!snakeCellSet.has(`${x},${y}`)) {
                            emptyCells.push({ x, y });
                        }
                    }
                }

                if (emptyCells.length > 0) {
                    apple = emptyCells[Math.floor(Math.random() * emptyCells.length)];
                } else {
                    // å¦‚æœæ²’æœ‰ç©ºä½ï¼ˆå‹åˆ©ï¼‰ï¼Œå‰‡åœæ­¢æ¨¡æ“¬
                    break;
                }
            } else {
                snake.pop();
            }

            // 6. æ¨é€²æ™‚é–“
            frameCount++;
        }
        return generatedFrames;
    }

    async function initializeReplay() {
      const urlParams = new URLSearchParams(window.location.search);
      const replayId = urlParams.get('id');

      if (!replayId) {
        statusText.textContent = "éŒ¯èª¤ï¼šURL ä¸­æ‰¾ä¸åˆ°å›æ”¾ IDã€‚";
        return;
      }

      try {
        statusText.textContent = "æ­£åœ¨å¾ Firebase è®€å–ç´€éŒ„...";
        const doc = await db.collection("replays").doc(replayId).get();

        if (doc.exists) {
          const data = doc.data();
          statusText.textContent = "æ­£åœ¨ç”¢ç”Ÿå›æ”¾ç•«é¢...";

          replayData = generateFramesFromHistory(data.initialState, data.moves);

          if (replayData.length === 0) {
              statusText.textContent = "éŒ¯èª¤ï¼šç„¡æ³•ç”Ÿæˆå›æ”¾è³‡æ–™ï¼Œå¯èƒ½æ˜¯ç´€éŒ„æœ‰å•é¡Œã€‚";
              return;
          }

          statusText.textContent = `æˆåŠŸè¼‰å…¥ï¼æœ€çµ‚åˆ†æ•¸ï¼š${data.finalScore}`;
          progressSlider.max = replayData.length - 1;
          drawFrame(0);

          playPauseBtn.addEventListener("click", togglePlayPause);
          restartBtn.addEventListener("click", restart);
          progressSlider.addEventListener("input", (e) => {
              pause();
              drawFrame(parseInt(e.target.value));
          });

          // æ–°å¢ï¼šç›£è½ç©ºç™½éµä¾†æ’­æ”¾/æš«åœ
          document.addEventListener('keydown', (e) => {
            if (e.code === 'Space') {
              e.preventDefault(); // é˜²æ­¢é é¢æ»¾å‹•
              togglePlayPause();
            }
          });

        } else {
          statusText.textContent = "éŒ¯èª¤ï¼šåœ¨è³‡æ–™åº«ä¸­æ‰¾ä¸åˆ°é€™å€‹å›æ”¾ç´€éŒ„ã€‚";
        }
      } catch (error) {
        console.error("Error fetching replay: ", error);
        statusText.textContent = "è®€å–ç´€éŒ„å¤±æ•—ï¼Œè«‹æª¢æŸ¥ä¸»æ§å°éŒ¯èª¤è¨Šæ¯ã€‚";
      }
    }

    // ä¿®æ”¹ back-link çš„ hrefï¼Œå°‡ç•¶å‰å›æ”¾ URL å‚³å›å»
    function setBackLink() {
        const backLink = document.getElementById('back-link');
        const currentUrl = window.location.href;
        backLink.href = `index.html?last_replay_url=${encodeURIComponent(currentUrl)}`;
    }

    initializeReplay();
    setBackLink();
  </script>
</body>
</html>